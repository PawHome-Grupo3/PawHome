<!DOCTYPE html>
<html lang="es" xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">

<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/Dona.css}">
    <title th:text="#{dona.titulo}">Dona</title>
</head>

<body class="dona-body">
<section layout:fragment="content" class="dona-content">
    <div class="dona-overlay">

        <!-- Título principal -->
        <div class="dona-header">
            <h1><b th:text="#{dona.comoDonar}">¿Cómo puedes donar?</b></h1>
        </div>

        <!-- Sección de iconos -->
        <div class="dona-columnas">
            <!-- Columna recursos monetarios -->
            <div class="dona-columna">
                <p th:text="#{dona.recursos.monetarios}">Recursos monetarios</p>

                <!-- PayPal -->
                <a href="#" data-bs-toggle="modal" data-bs-target="#paypalModal" th:title="#{dona.paypal.titulo}">
                    <div class="dona-icono">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" />
                    </div>
                </a>

                <!-- Bizum -->
                <a th:href="@{/colabora/dona/donarBizum}" th:title="#{dona.bizum.titulo}">
                    <div class="dona-icono">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/2/2b/Bizum.svg" alt="Bizum" />
                    </div>
                </a>
            </div>

            <!-- Columna recursos materiales -->
            <div class="dona-columna">
                <p th:text="#{dona.recursos.materiales}">Recursos materiales</p>

                <!-- Correos -->
                <a href="/donaciones-materiales" th:title="#{dona.correos.titulo}">
                    <div class="dona-icono">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_Correos_2019.svg" alt="Correos" />
                    </div>
                </a>
            </div>
        </div>

        <!-- Mensaje de agradecimiento -->
        <h3 class="dona-gracias">
            <b th:text="#{dona.gracias}">
                Gracias a tu apoyo, podemos seguir cuidando y protegiendo a los animales que más lo necesitan.
                br>
                ¡Tu ayuda marca la diferencia!
            </b>
        </h3>

    </div>

    <!-- Modal PayPal (ahora usa Stripe) -->
    <div class="modal fade" id="paypalModal" tabindex="-1" aria-labelledby="paypalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="paypalModalLabel">Donar vía Stripe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <form id="checkoutForm">
                    <div class="modal-body text-center">

                        <label for="cantidad" class="form-label">¿Cuánto deseas donar? (EUR)</label>
                        <div class="input-group w-50 mx-auto">
                            <input type="number" class="form-control" id="cantidad" name="cantidad" min="0.01" step="0.01" value="5" required>
                            <span class="input-group-text">€</span>
                            <div class="invalid-feedback">Introduce una cantidad válida mayor a 0.</div>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Donar ahora</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const input = document.getElementById("cantidad");
            const form = document.getElementById("checkoutForm");

            // Solo permitir números y punto decimal
            input.addEventListener("keypress", function (e) {
                const char = String.fromCharCode(e.which);
                if (!/[0-9.]|\./.test(char)) {
                    e.preventDefault();
                }
            });

            form.addEventListener("submit", async function (e) {
                e.preventDefault();

                const cantidad = parseFloat(input.value);

                if (isNaN(cantidad) || cantidad <= 0) {
                    input.classList.add("is-invalid");
                    return;
                } else {
                    input.classList.remove("is-invalid");
                }

                try {
                    const response = await fetch("/colabora/dona/checkout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            cantidad: cantidad
                        })
                    });

                    const data = await response.json();

                    if (data.status === "SUCCESS") {
                        window.location.href = data.sessionUrl;
                    } else {
                        alert("Error al iniciar el pago: " + data.message);
                    }

                } catch (error) {
                    console.error("Error al conectar con el servidor:", error);
                    alert("No se pudo procesar el pago.");
                }
            });
        });
    </script>
</section>
</body>
</html>
