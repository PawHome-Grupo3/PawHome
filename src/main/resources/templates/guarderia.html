<!DOCTYPE html>
<html lang="es" xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layouts/layout.html}">
<head>
	<title th:utext="#{page.guarderia.tittle}"></title>
	<link rel="stylesheet" th:href="@{/css/servicios.css}"/>
</head>
<body>
<section layout:fragment="content">
	<section class="container py-5 mainContainer">

		<!-- Sección: Nuestra guardería -->
		<section class="text-center rounded-4 shadow mx-2 my-3 p-3 seccionTitulo">
			<div class="container px-4">
				<h2 class="fw-bold display-5 text-success-emphasis mb-3">
					<i class="fas fa-home me-2"></i>
					<span th:utext="#{page.guarderia.tittle}"></span>
				</h2>
				<p class="fs-5">
					<i class="fas fa-paw me-2 text-success"></i>
					<span th:utext="#{servicios.guarderia.eslogan1}"></span><br>
					<i class="fas fa-heart me-2 text-success"></i>
					<span th:utext="#{servicios.guarderia.eslogan2}"></span>
					<i class="fas fa-dog ms-2 me-1 text-success"></i>
					<i class="fas fa-cat me-1 text-success"></i>
				</p>
			</div>
		</section>
		<hr class="mx-auto w-100 border-2 opacity-50">

		<!-- Sección: Nuestras tarifas -->
		<section class="text-center mb-5">
			<h2 class="fw-bold text-success-emphasis mb-4">
				<i class="fas fa-paw me-2"></i>
				<span th:utext="#{servicios.guarderia.nuestrasTarifas}"></span>
			</h2>

			<div class="row row-cols-1 row-cols-md-3 g-4">
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio" data-precio="18" data-min-dias="1" data-max-dias="5">
						<div class="card_image">
							<img th:src="@{images/estanciaExpres.png}" alt="LogoEstanciaExpress" class="imagenCard">
						</div>
						<h3 class="card-title mt-3 fs-4 fw-bold text-success-emphasis"
							th:utext="#{servicios.guarderia.estanciaExpress.titulo}"></h3>
						<p class="fw-bold fs-5 mb-1" th:utext="#{servicios.guarderia.estanciaExpress.precio}"></p>
						<p th:utext="#{servicios.guarderia.estanciaExpress.duracion}"></p>
						<ul class="list-unstyled">
							<li><i class="fas fa-bone me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeComida}"></span>
							</li>
							<li><i class="fas fa-bed me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeAlojamiento}"></span>
							</li>
							<li><i class="fas fa-futbol me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeEntretenimiento}"></span>
							</li>
						</ul>
						<button class="btn btn-success btnCard" id="btnEstanciaExpress"
								th:utext="#{servicios.botonSeleccionar}">
						</button>
					</div>
				</article>
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio" data-precio="15" data-min-dias="6" data-max-dias="10">
						<div class="card_image">
							<img th:src="@{images/estanciaRelax.jpg}" alt="LogoEstanciaRelax" class="imagenCard">
						</div>
						<h3 class="card-title mt-3 fs-4 fw-bold text-success-emphasis"
							th:utext="#{servicios.guarderia.estanciaRelax.titulo}"></h3>
						<p class="fw-bold fs-5 mb-1" th:utext="#{servicios.guarderia.estanciaRelax.precio}"></p>
						<p th:utext="#{servicios.guarderia.estanciaRelax.duracion}"></p>
						<ul class="list-unstyled">
							<li><i class="fas fa-bone me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeComida}"></span>
							</li>
							<li><i class="fas fa-bed me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeAlojamiento}"></span>
							</li>
							<li><i class="fas fa-futbol me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeEntretenimiento}"></span>
							</li>
						</ul>
						<button class="btn btn-success btnCard" id="btnEstanciaRelax"
								th:utext="#{servicios.botonSeleccionar}">
						</button>
					</div>
				</article>
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio" data-precio="12" data-min-dias="11"
						 data-max-dias="999">
						<div class="card_image">
							<img th:src="@{images/estanciaSabatica.jpg}" alt="LogoEstanciaSabatica" class="imagenCard">
						</div>
						<h3 class="card-title mt-3 fs-4 fw-bold text-success-emphasis"
							th:utext="#{servicios.guarderia.estanciaSabatica.titulo}"></h3>
						<p class="fw-bold fs-5 mb-1" th:utext="#{servicios.guarderia.estanciaSabatica.precio}"></p>
						<p th:utext="#{servicios.guarderia.estanciaSabatica.duracion}"></p>
						<ul class="list-unstyled">
							<li><i class="fas fa-bone me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeComida}"></span>
							</li>
							<li><i class="fas fa-bed me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeAlojamiento}"></span>
							</li>
							<li><i class="fas fa-futbol me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeEntretenimiento}"></span>
							</li>
						</ul>
						<button class="btn btn-success btnCard" id="btnEstanciaSabatica"
								th:utext="#{servicios.botonSeleccionar}">
						</button>
					</div>
				</article>
			</div>
		</section>
		<hr class="mx-auto w-100 border-2 opacity-50">

		<!-- Sección: Descubre nuestros bonos -->
		<section class="text-center mb-5">
			<h2 class="fw-bold text-success-emphasis mb-4">
				<i class="fas fa-gift me-2"></i>
				<span th:utext="#{servicios.guarderia.descubreBonos}"></span>
			</h2>

			<div class="row g-4 d-flex justify-content-center">
				<article class="col-6 col-md-4">
					<div class="card p-3 shadow-sm cardServicio" data-precio="200">
						<div class="card_image">
							<img th:src="@{images/bonoLargaEstancia.jpg}" alt="BonoLargaEstancia" class="imagenCard">
						</div>
						<h3 class="card-title mt-3 fs-4 fw-bold text-success-emphasis"
							th:utext="#{servicios.guarderia.bonoLargaEstancia.titulo}"></h3>
						<p class="fw-bold fs-5 mb-1" th:utext="#{servicios.guarderia.bonoLargaEstancia.precio}"></p>
						<p th:utext="#{servicios.guarderia.bonoLargaEstancia.duracion}"></p>
						<ul class="list-unstyled">
							<li><i class="fas fa-bone me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeComida}"></span>
							</li>
							<li><i class="fas fa-bed me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeAlojamiento}"></span>
							</li>
							<li><i class="fas fa-futbol me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeEntretenimiento}"></span>
							</li>
						</ul>
						<p th:utext="#{servicios.guarderia.elegirDias}"></p>
						<button class="btn btn-success btnCard cardBono" id="btnBonoLargaEstancia"
								th:utext="#{servicios.botonSeleccionar}">
						</button>
					</div>
				</article>
				<article class="col-6 col-md-4">
					<div class="card p-3 shadow-sm cardServicio" data-precio="75">
						<div class="card_image">
							<img th:src="@{images/bonoSoloDia.jpg}" alt="BonoSoloDia" class="imagenCard">
						</div>
						<h3 class="card-title mt-3 fs-4 fw-bold text-success-emphasis"
							th:utext="#{servicios.guarderia.bonoSoloDia.titulo}"></h3>
						<p class="fw-bold fs-5 mb-1" th:utext="#{servicios.guarderia.bonoSoloDia.precio}"></p>
						<p th:utext="#{servicios.guarderia.bonoSoloDia.duracion}"></p>
						<ul class="list-unstyled">
							<li><i class="fas fa-bone me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeComida}"></span>
							</li>
							<li><i class="fas fa-bed me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeAlojamiento}"></span>
							</li>
							<li><i class="fas fa-futbol me-2 text-success"></i>
								<span th:utext="#{servicios.guarderia.incluyeEntretenimiento}"></span>
							</li>
						</ul>
						<p th:utext="#{servicios.guarderia.elegirDias}"></p>
						<button class="btn btn-success btnCard cardBono" id="btnBonoEstanciaSoloDia"
								th:utext="#{servicios.botonSeleccionar}">
						</button>
					</div>
				</article>
			</div>
		</section>
		<hr class="mx-auto w-100 border-2 opacity-50">

		<!-- Sección: Formulario de contacto -->
		<section class="mb-5">
			<h2 class="text-success-emphasis fw-bold display-5 my-4 text-center"
				th:utext="#{servicios.reservaEstancia}"></h2>
			<div class="formContainer">
				<form class="row g-3">
					<fieldset class="col-md-6">
						<div class="itemSeleccion">
							<legend class="fw-bold">Datos de la mascota</legend>
							<label for="nombreMascota" class="form-label">Nombre de la mascota: <span
									style="color: red">*</span></label>
							<input type="text" id="nombreMascota" class="form-control labelForm"
								   placeholder="-Por favor introduce el nombre de tu mascota-" required>
						</div>

						<div class="itemSeleccion">
							<label for="caracterMascota" class="form-label">Caracter social: <span
									style="color: red">*</span></label>
							<select id="caracterMascota" class="form-select labelForm" required>
								<option value="" disabled selected>-Por favor, elige una opción-</option>
								<option>Sociable</option>
								<option>No sociable</option>
							</select>
						</div>

						<div class="itemSeleccion">
							<label for="tipoMascota" class="form-label">Tipo: <span style="color: red">*</span></label>
							<select id="tipoMascota" class="form-select labelForm" required>
								<option value="" disabled selected>-Por favor, elige una opción-</option>
								<option>Perro</option>
								<option>Gato</option>
								<option>Otro</option>
							</select>
						</div>

						<div class="itemSeleccion">
							<label for="necesitaMedicacion" class="form-label">Necesita medicación: <span
									style="color: red">*</span></label>
							<select id="necesitaMedicacion" class="form-select labelForm" required>
								<option value="" disabled selected>-Por favor, elige una opción-</option>
								<option>Sí</option>
								<option>No</option>
							</select>
						</div>

						<div class="itemSeleccion">
							<label for="fechaEntrada" class="form-label">Fecha de entrada: <span
									style="color: red">*</span></label>
							<input type="date" id="fechaEntrada" class="form-control labelForm" required>
						</div>

						<div class="itemSeleccion">
							<label for="fechaSalida" class="form-label">Fecha de salida: <span
									style="color: red">*</span></label>
							<input type="date" id="fechaSalida" class="form-control labelForm" required>
						</div>
					</fieldset>

					<fieldset class="col-md-6">
						<div class="itemSeleccion">
							<legend class="fw-bold">Datos de contacto</legend>
							<label for="nombreDueño" class="form-label">Tu nombre: <span
									style="color: red">*</span></label>
							<input th:value="${usuario != null} ? ${usuario.getPerfilDatos().getNombre()} : ''"
								   type="text" id="nombreDueño" class="form-control labelForm"
								   placeholder="-Por favor introduce tu nombre-" disabled>
						</div>

						<div class="itemSeleccion">
							<label for="telefonoDueño" class="form-label">Teléfono: <span
									style="color: red">*</span></label>
							<input th:value="${usuario != null} ? ${usuario.getPerfilDatos().telefono1} : ''" type="tel"
								   id="telefonoDueño" class="form-control labelForm"
								   placeholder="-Por favor introduce tu número de teléfono-" disabled>
						</div>

						<div class="itemSeleccion">
							<label for="emailDueño" class="form-label">Correo electrónico: <span
									style="color: red">*</span></label>
							<input th:value="${usuario != null} ? ${usuario.getEmail()} : ''" type="email"
								   id="emailDueño" class="form-control labelForm"
								   placeholder="-Por favor introduce tu correo electrónico-" disabled>
						</div>

						<div class="itemSeleccion">
							<label for="mensajeExtra" class="form-label">Mensaje:</label>
							<input type="text" id="mensajeExtra" class="form-control labelForm">
						</div>
					</fieldset>

					<div class="itemSeleccion">
						<label class="form-label fw-bold fs-5">Tarifa seleccionada: </label>
						<span id="tarifaSeleccionada" class="fw-normal"></span>
					</div>

					<div class="itemSeleccion">
						<label class="form-label fw-bold fs-3" id="precioTotal">PRECIO TOTAL: </label>
					</div>

					<div class="itemSeleccion">
						<input type="checkbox" class="" required>
						<label class="form-label">He leído y acepto las condiciones de uso de la web,
							el aviso legal y la política de privacidad</label>
					</div>
				</form>
				<form id="checkoutGuarderia" method="post" th:action="@{/guarderia/checkoutGuarderia}">
					<input type="hidden" id="nombreProducto" name="nombreProducto">
					<input type="hidden" id="cantidadDias" name="cantidadDias">
					<button type="submit" class="btn btn-primary btnEnviar">RESERVAR</button>
				</form>
			</div>
		</section>
		<hr class="mx-auto w-100 border-2 opacity-50">

		<!-- Sección: otros servicios-->
		<section class="text-center mb-1">
			<h2 class="text-success-emphasis fw-bold display-5 my-4"
				th:utext="#{servicios.otrosServicios}"></h2>
			<div class="row row-cols-1 row-cols-md-4 g-4">
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio">
						<div class="card_image">
							<img th:src="@{images/peluqueriaCanina.jpg}" alt="LogoPeluqueria" class="imagenCard">
						</div>
						<h3 class="mt-3 fs-3 fw-bold text-success-emphasis"
							th:utext="#{servicios.peluqueria}"></h3>
						<p class="fs-4" th:utext="#{servicios.peluqueriaApartirDe}"></p>
						<a th:href="@{/peluqueria}" class="btn btn-success"
						   th:utext="#{servicios.masInfo}">
						</a>
					</div>
				</article>
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio">
						<div class="card_image">
							<img th:src="@{images/adiestramiento.jpg}" alt="LogoAdiestramiento" class="imagenCard">
						</div>
						<h3 class="mt-3 fs-3 fw-bold text-success-emphasis"
							th:utext="#{servicios.adiestramiento}"></h3>
						<p class="fs-4" th:utext="#{servicios.adiestramientoApartirDe}"></p>
						<a th:href="@{/adiestramiento}" class="btn btn-success"
						   th:utext="#{servicios.masInfo}">
						</a>
					</div>
				</article>
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio">
						<div class="card_image">
							<img th:src="@{images/veterinario.jpg}" alt="LogoVeterinario" class="imagenCard">
						</div>
						<h3 class="mt-3 fs-3 fw-bold text-success-emphasis"
							th:utext="#{servicios.veterinario}"></h3>
						<p class="fs-4" th:utext="#{servicios.veterinarioApartirDe}"></p>
						<a th:href="@{/veterinario}" class="btn btn-success"
						   th:utext="#{servicios.masInfo}">
						</a>
					</div>
				</article>
				<article class="col">
					<div class="card p-3 shadow-sm cardServicio">
						<div class="card_image">
							<img th:src="@{images/asesoramientoLegal.jpg}" alt="LogoLegal" class="imagenCard">
						</div>
						<h3 class="mt-3 fs-3 fw-bold text-success-emphasis"
							th:utext="#{servicios.asesoramientoLegal}"></h3>
						<p class="fs-4" th:utext="#{servicios.asesoramientoApartirDe}"></p>
						<a th:href="@{/asesoramientoLegal}" class="btn btn-success"
						   th:utext="#{servicios.masInfo}">
						</a>
					</div>
				</article>
			</div>
		</section>
	</section>

	<div id="errorDias" class="text-danger mt-1"></div>

	<!-- Script para controlar la seleccion y gestion de dias -->
	<script>
        document.addEventListener('DOMContentLoaded', function () {
            const btns = document.querySelectorAll('.btnCard');
            const tarifaSpan = document.getElementById('tarifaSeleccionada');
            const precioTotal = document.getElementById('precioTotal');
            const fechaEntrada = document.getElementById('fechaEntrada');
            const fechaSalida = document.getElementById('fechaSalida');
            const errorDias = document.getElementById('errorDias');

            let tarifaSeleccionada = null;
            let esBono = false;

            // Obtener la fecha de hoy en formato YYYY-MM-DD
            const hoy = new Date().toISOString().split('T')[0];
            fechaEntrada.min = hoy;

            // Suma días a una fecha y devuelve en formato YYYY-MM-DD
            function sumarDias(fecha, dias) {
                const nuevaFecha = new Date(fecha);
                nuevaFecha.setDate(nuevaFecha.getDate() + dias);
                return nuevaFecha.toISOString().split('T')[0];
            }

            // Calcula los días entre dos fechas
            function calcularDias(inicio, fin) {
                const unDiaMs = 1000 * 60 * 60 * 24;
                const diffMs = fin - inicio;
                return Math.ceil(diffMs / unDiaMs);
            }

            // Ajusta el rango de la fecha de salida según la tarifa seleccionada
            function ajustarRangoFechaSalida() {
                if (!tarifaSeleccionada || !fechaEntrada.value) {
                    fechaSalida.min = fechaEntrada.value || hoy;
                    fechaSalida.max = "";
                    return;
                }
                const minDias = parseInt(tarifaSeleccionada.minDias);
                const maxDias = parseInt(tarifaSeleccionada.maxDias);

                fechaSalida.min = sumarDias(fechaEntrada.value, minDias);
                fechaSalida.max = sumarDias(fechaEntrada.value, maxDias);

                // Si la fecha de salida actual está fuera del rango, resetea
                if (fechaSalida.value) {
                    if (fechaSalida.value < fechaSalida.min || fechaSalida.value > fechaSalida.max) {
                        fechaSalida.value = "";
                    }
                }
            }

            // Actualiza el precio total y valida los días
            function actualizarPrecio() {
                errorDias.textContent = "";

                // Si es bono, solo muestra el precio del bono y desactiva fechas
                if (esBono && tarifaSeleccionada) {
                    precioTotal.textContent = `PRECIO TOTAL: ${tarifaSeleccionada.precio}€`;
                    return;
                }

                // Si no hay tarifa seleccionada o fechas, resetea
                if (!tarifaSeleccionada || !fechaEntrada.value || !fechaSalida.value) {
                    precioTotal.textContent = "PRECIO TOTAL: ";
                    return;
                }

                const inicio = new Date(fechaEntrada.value);
                const fin = new Date(fechaSalida.value);

                if (fin <= inicio) {
                    precioTotal.textContent = "ERROR: La fecha de salida debe ser posterior a la de entrada.";
                    return;
                }

                const dias = calcularDias(inicio, fin);
                const minDias = parseInt(tarifaSeleccionada.minDias);
                const maxDias = parseInt(tarifaSeleccionada.maxDias);

                if (dias < minDias || dias > maxDias) {
                    precioTotal.textContent = "PRECIO TOTAL: ";
                    let mensaje = `Esta tarifa solo permite estancias de `;
                    if (maxDias >= 999) {
                        mensaje += `${minDias} días o más.`;
                    } else {
                        mensaje += `entre ${minDias} y ${maxDias} días.`;
                    }
                    errorDias.textContent = mensaje;
                    return;
                }

                errorDias.textContent = "";
                const total = dias * tarifaSeleccionada.precio;
                precioTotal.innerHTML = `PRECIO TOTAL: ${total}€ <small class="text-muted">(${dias} días)</small>`;
            }

            // Evento para seleccionar una tarifa o bono
            btns.forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();

                    const card = btn.closest('.cardServicio');
                    const isBono = btn.classList.contains('cardBono');

                    // Si ya está seleccionada, desmarcar y resetear
                    if (card.classList.contains('selected')) {
                        card.classList.remove('selected');
                        tarifaSeleccionada = null;
                        esBono = false;
                        tarifaSpan.textContent = '';
                        precioTotal.textContent = "PRECIO TOTAL: ";
                        errorDias.textContent = "";
                        fechaEntrada.disabled = false;
                        fechaSalida.disabled = false;
                        ajustarRangoFechaSalida();
                        return;
                    }

                    // Desmarcar todas las seleccionadas
                    document.querySelectorAll('.cardServicio.selected').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');

                    // Si es bono
                    if (isBono) {
                        esBono = true;
                        // Desactivar fechas y limpiar valores
                        fechaEntrada.disabled = true;
                        fechaSalida.disabled = true;
                        fechaEntrada.value = "";
                        fechaSalida.value = "";
                        errorDias.textContent = "";

                        tarifaSeleccionada = {
                            precio: parseFloat(card.dataset.precio),
                            nombre: card.querySelector('.card-title').textContent.trim()
                        };

                        tarifaSpan.textContent = `${tarifaSeleccionada.nombre}`;
                        actualizarPrecio();
                        return;
                    }

                    // Si es tarifa normal
                    esBono = false;
                    fechaEntrada.disabled = false;
                    fechaSalida.disabled = false;

                    tarifaSeleccionada = {
                        precio: parseFloat(card.dataset.precio),
                        nombre: card.querySelector('.card-title').textContent.trim(),
                        minDias: card.dataset.minDias,
                        maxDias: card.dataset.maxDias
                    };

                    tarifaSpan.textContent = `${tarifaSeleccionada.nombre} - ${tarifaSeleccionada.precio}€/día`;
                    ajustarRangoFechaSalida();
                    actualizarPrecio();
                });
            });

            // Cuando cambia la fecha de entrada, ajusta el rango de salida y recalcula
            fechaEntrada.addEventListener('change', function () {
                if (!esBono) {
                    ajustarRangoFechaSalida();
                    actualizarPrecio();
                }
            });

            // Cuando cambia la fecha de salida, recalcula
            fechaSalida.addEventListener('change', function () {
                if (!esBono) {
                    actualizarPrecio();
                }
            });

            // Inicializa el mínimo de salida al cargar la página
            if (fechaEntrada.value) {
                fechaSalida.min = fechaEntrada.value;
            } else {
                fechaSalida.min = hoy;
            }

            document.getElementById('checkoutGuarderia').addEventListener('submit', async function(event) {
                event.preventDefault();

                const form = event.target;

                // Validar selección
                if (!tarifaSeleccionada) {
                    alert("Selecciona una tarifa o bono antes de reservar.");
                    return;
                }

                // Obtener nombre y cantidad de días
                const nombreProducto = tarifaSeleccionada.nombre;
                let cantidadDias = 1;
                if (!esBono && fechaEntrada.value && fechaSalida.value) {
                    cantidadDias = calcularDias(new Date(fechaEntrada.value), new Date(fechaSalida.value));
                }

                // Prepara datos para enviar como JSON
                const formData = {
                    nombreProducto: nombreProducto,
                    cantidadDias: cantidadDias
                };

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (data.status === "SUCCESS") {
                        window.location.href = data.sessionUrl; // Redirige a Stripe
                    } else {
                        alert("Error en la reserva: " + (data.message || "Sin mensaje"));
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error al procesar la reserva");
                }
            });
        });
	</script>
</section>
</body>
</html>